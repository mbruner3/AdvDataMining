---
title: "Safe Babies Car Seat Price Optimization"
author: "Mark Bruner"
course: "64011: Advanced Data Mining"
date: "21 March 2021"
output: 
  pdf_document: default
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
```

```{r, warning=FALSE, message=FALSE, tidy=TRUE}
library(tidyverse)
library(glmnet)
library(corrplot)
library(ISLR)
```

```{r, tidy=TRUE}
safe_babies <- Carseats %>%  
  select("Sales", "Price", "ShelveLoc")

  # Creating profit column for future visualizations. 
  # Equation for profit: (price - cost) * (quantity of sales)
safe_babies$profit <- (safe_babies$Price - 55) * safe_babies$Sales 
```

# **Part 1: Exploratory Data Analysis**

## **Univariate Analysis**

### Measures of Central Tendancy and Dispersion
All columns have means and medians fairly close together, which means that they are more normally distributed. The 1st and 3rd quartiles are mostly symmetrical around the mean/median. The "ShelveLoc" column's category "Medium" is where most of the carseats are located.

```{r, echo=FALSE, tidy=TRUE}
summary(safe_babies)
```
\newpage
### Histograms of Carseats in Good Shelf locations
From these plots, it confirms that the columns of profit and price are normally distributed. The sales column is more skewed to the right. I don't see any outliers that are mistakes. The prices are all positive as well as the sales which is what you would expect to see. The profit has a negative value but profit can be negative if the price of carseats is less than the cost of production so that doesn't seem unrealistic.

```{r, echo=FALSE, fig.width= 5, fig.align='center', tidy=TRUE}
safe_babies %>%
  filter(ShelveLoc == "Good") %>% 
  keep(is.numeric) %>%                     # Keep only numeric columns
  gather() %>%                             # Convert to key-value pairs
  ggplot(aes(value)) + # Plot the values
    facet_wrap(~ key, scales = "free") +   # In separate panels
    geom_histogram(bins = 30)
```
\newpage
### Histograms of Carseats in Bad Shelf locations
From these plots, it confirms that the columns are more normally distributed. The price column seems to have an outlier that is more extreme but since the dataset if fairly small, 1 price that is outside the norm is worth looking into but it doesn't seem too extreme. 

```{r, echo=FALSE, fig.width= 5, fig.align='center', tidy=TRUE}
safe_babies %>%
  filter(ShelveLoc == "Bad") %>% 
  keep(is.numeric) %>%                     # Keep only numeric columns
  gather() %>%                             # Convert to key-value pairs
  ggplot(aes(value)) + # Plot the values
    facet_wrap(~ key, scales = "free") +   # In separate panels
    geom_histogram(bins = 30) 
```
\newpage
## **Bivariate Analysis**

### Relationship Between Sales & Price
Their is a negative relationship between sales and price, which is what you would expect. As price increases, sales decrease and visa versa. You would also expect carseats placed in a good shelf location would have, on average, higher sales. The lower the shelf location the lower the sales. You can see that the green dots (representing good shelf location), have mostly higher sales compared to the other locations. 

```{r, echo=FALSE, fig.width= 5, fig.align='center', tidy=TRUE}
safe_babies %>% 
  ggplot(aes(Sales, Price, color = ShelveLoc))+
  geom_point()
```
\newpage

### **Boxplot Analysis by Sales and Price**
Most of the outliers were in the medium shelf location and the better the shelf location the better the sales, on average. The other interesting relationship was that the price spread for both medium and good shelf locations were almost identical.

```{r, echo=FALSE, figures-side1, fig.show="hold", out.width="50%", tidy=TRUE}
safe_babies %>% 
  ggplot(aes(Sales, ShelveLoc, color = ShelveLoc))+
  geom_boxplot()


safe_babies %>% 
  ggplot(aes(Price, ShelveLoc, color = ShelveLoc))+
  geom_boxplot()
```

### **Outlier Table Analysis**

The negative profit is associated with those with prices below the $55 cost which is to be expected. The others with high prices have low sales which again makes sense. The outliers seem to be more informative than mistakes. Also, most of them are in the "Medium" location and we will be looking at Bad and Good shelf locations so I don't believe any further action is necessary for the outliers.

```{r echo=FALSE, center ,tidy=TRUE, paged.print=TRUE}
# Looking at the outliers that the boxplots to check for errors.

safe_babies %>% 
  filter(Price < 60| Price > 175 | Sales < .2) %>% 
  arrange(Price)
```

\newpage
### **Multivariate Analysis**

The price, good and bad shelf locations are all fairly uncorrelated. The "Good" and "Bad" shelf locations have a slight negative correlation of .29 but shouldn't be too much of a problem. "Medium" is highly negatively correlated with "Good" and "Bad".

```{r, fig.width= 5, fig.align='center', tidy=TRUE}
# One hot encoding the shelf location to keep them in the glm.
safe_babies_mx <- model.matrix( ~ .-1, safe_babies[,1:4])

# Separating the sales variable from the other variables. Will check to see if the predictors are independent of one another.
x = safe_babies_mx[, 2:5]
y = safe_babies_mx[, 1]

safebabies_cor <- cor(safe_babies_mx)

corrplot(safebabies_cor, method = "shade", type = "upper")
```
\newpage
# **Part 2: Model Building**

### Optimal GLM model for Sales & Price Based on Location

```{r, tidy=TRUE}
# Using 20 fold cross-validation to find the optimal glm model for our dataset.
for (a in seq(0,1,by=0.1)) {
cv.fit <- cv.glmnet(x, y, alpha = a, nfolds = 20)
print(paste0("alpha is ", a, " and best MSE is " , min(cv.fit$cvm)))
}
```

**It looks like the alpha value at .9 is optimal.**

```{r, tidy=TRUE}
# The Best Fit Model for This Dataset
best_fit <- coef(cv.fit, s = "lambda.min")
best_fit
```

Using the best fitted model from above to model the relationship between sales and price + shelf location. You will notice that Medium shelf location was eliminated from this model.

\newpage
# **Part 3: Optimal Price for $55 Cost** 

```{r, tidy=TRUE}
# Created a function to find the optimal value based on shelf location.
# cost is the cost of carseat production, good and bad represent shelf location and they are binary.
optimal <- function(cost, good, bad) {
  # Derivative of the first term in the quadratic profit equation 
  x1 <- 2*best_fit[2] 
  
  #Derivative of the second term in the profit equation
   x2 <- -1*best_fit[1] + 
     -1*best_fit[3] * bad + 
     -1*best_fit[4] * good + 
     (best_fit[2]*cost)
   
  #Solving the derivative for max price unknown 
   optimal_price <- x2/x1
   
   optimal_sales <- best_fit[1] + best_fit[3] * bad + best_fit[4]*good + best_fit[2]*optimal_price
   
   optimal_profit <- (optimal_price - cost) * optimal_sales
   return(as.data.frame(cbind("price" = round(optimal_price, 2), 
                              "sales" = round(optimal_sales, 2),
                              "profit" = round(optimal_profit, 2))))
}
```

### Optimal Price, Sales, and Profit for Good Shelf Location

```{r, tidy=TRUE}
optimal(55, 1, 0)
```

#### Optimal price for a $55 cost is $176.98 or $177. Optimal sales is 6.87 thousand carseats which will provide $837.95 thousand dollar profit.

```{r, echo=FALSE, tidy=TRUE}
price <- as.data.frame(seq(1,300, by = 1)) # created a dataframe for plotting the quadratic equation for profit from 1 to 300.

price <- price %>% 
  rename(seq_price = "seq(1, 300, by = 1)")
bad = 0
good = 1
cost = 55
# Derivative of the first term in the quadratic profit equation 
  x1 <- 2*best_fit[2] 
  
  #Derivative of the second term in the profit equation
   x2 <- -1*best_fit[1] + 
     -1*best_fit[3] * bad + 
     -1*best_fit[4] * good + 
     (best_fit[2]*cost)

derivative <- x1*price + -1*x2 # derivative of the quadratic equation.
derivative <- derivative %>% rename(d = "seq_price")
  #Solving the derivative for max price unknown 
   optimal_price <- x2/x1
   
   optimal_sales <- best_fit[1] + best_fit[3] * bad + best_fit[4]*good + best_fit[2]*price
   optimal_sales <- optimal_sales %>% 
  rename(good_sales = "seq_price")
   optimal_profit <- (price - cost) * optimal_sales
   optimal_profit <- optimal_profit %>% 
  rename(good_profit = "seq_price")
   opt_df = as.data.frame(cbind(price, optimal_sales, optimal_profit, derivative))
```


```{r, echo=FALSE, warning=FALSE, fig.width= 5, fig.align='center', tidy=TRUE}
good_safe_babies <- safe_babies %>% 
                      filter(ShelveLoc == "Good")

ggplot()+
  geom_line(data = opt_df, 
            mapping = aes(x = seq_price, y = good_profit), 
            colour = "deepskyblue4",
            size = 1)+
  geom_line(data = opt_df,
            mapping = aes(x = seq_price, y = d), color = "firebrick") +
  geom_point(data = good_safe_babies, 
             mapping = aes(x = Price, y = profit), 
             colour = "gainsboro") +
  geom_hline(data = opt_df, 
             yintercept = max(optimal_profit), 
             color = "dimgray", 
             linetype = "dashed")+
  geom_vline(xintercept = optimal_price,
             color = "dimgray",
             linetype = "dashed")+ 
  theme_minimal() +
  theme(panel.grid.minor = element_blank()) +
  ylab("Profit from Shelve Location: Good") +
  xlab("Price")
```

The plot above shows the fit of the profit quadratic equation to the good shelf data and shows that the derivative intercepts the x-axis at the optimal price of $177.

### Optimal Price, Sales, and Profit for Bad Shelf Location

```{r, tidy=TRUE}
optimal(55, 0, 1)
```

##### Optimal price for bad shelf location at a 55 cost is $133.8 or about $134. Optimal sales is 4.44 thousand carseats which will provide $349.73 thousand dollar profit.

```{r, echo=FALSE, tidy=TRUE}
good = 0
bad = 1
# Derivative of the first term in the quadratic profit equation 
  x1 <- 2*best_fit[2] 
  
  #Derivative of the second term in the profit equation
   x2 <- -1*best_fit[1] + 
     -1*best_fit[3] * bad + 
     -1*best_fit[4] * good + 
     (best_fit[2]*cost)

derivative <- x1*price + -1*x2 # derivative of the quadratic equation.
derivative <- derivative %>% rename(d = "seq_price")
  #Solving the derivative for max price unknown 
   optimal_price <- x2/x1

optimal_sales <- best_fit[1] + best_fit[3] * bad + best_fit[4]*good + best_fit[2]*price
   optimal_sales <- optimal_sales %>% 
  rename(bad_sales = "seq_price")
   optimal_profit <- (price - cost) * optimal_sales
   optimal_profit <- optimal_profit %>% 
  rename(bad_profit = "seq_price")
   opt_df = as.data.frame(cbind(price, optimal_sales, optimal_profit, derivative))
```


```{r, echo=FALSE, warning=FALSE, fig.width= 5, fig.align='center', tidy=TRUE}
bad_safe_babies <- safe_babies %>% 
                      filter(ShelveLoc == "Bad")

ggplot()+
  geom_line(data = opt_df, 
            mapping = aes(x = seq_price, y = bad_profit), 
            colour = "deepskyblue4",
            size = 1)+
  geom_line(data = opt_df,
            mapping = aes(x = seq_price, y = d), color = "firebrick") +
  geom_point(data = bad_safe_babies, 
             mapping = aes(x = Price, y =profit), 
             colour = "gainsboro") +
  geom_hline(data = opt_df, 
             yintercept = max(optimal_profit), 
             color = "dimgray", 
             linetype = "dashed")+
  geom_vline(xintercept = optimal_price,
             color = "dimgray",
             linetype = "dashed")+ 
  theme_minimal() +
  theme(panel.grid.minor = element_blank()) +
  ylab("Profit from Shelve Location: Bad") +
  xlab("Price")
```

T**he plot above shows the fit of the profit quadratic equation to the good shelf data and shows that the derivative intercepts the x-axis at the optimal price of $177.**

```{r, tidy=TRUE}
# Creating 
costs <- as.data.frame(seq(40, 85, by = 5))
costs <- costs %>% 
          rename('costs'=`seq(40, 85, by = 5)`)
```


```{r, tidy=TRUE}
for(i in costs) {
  # i-th element of `costs` used to find good shelf optimal sales, price, and profit
  good_results <- as.data.frame(optimal(i, 1, 0))
  good_results <- (cbind(costs, good_results))
}
```


```{r, echo=FALSE}
good_results$increase_profit <- c(good_results$profit[1] - good_results$profit[2], good_results$profit[2] - good_results$profit[3], good_results$profit[3] - good_results$profit[4], good_results$profit[4] - good_results$profit[5], good_results$profit[5] - good_results$profit[6], good_results$profit[6] - good_results$profit[7], good_results$profit[7] - good_results$profit[8], good_results$profit[8] - good_results$profit[9], good_results$profit[9] - good_results$profit[10], 0)
```


```{r}
for(i in costs) {
  # i-th element of `costs` used to find bad shelf optimal sales, price, and profit
  bad_results <- as.data.frame(optimal(i, 0, 1))
  bad_results <- (cbind(costs, bad_results))
}
```


```{r, echo=FALSE}
bad_results$increase_profit <- c(bad_results$profit[1] - bad_results$profit[2], bad_results$profit[2] - bad_results$profit[3], bad_results$profit[3] - bad_results$profit[4], bad_results$profit[4] - bad_results$profit[5], bad_results$profit[5] - bad_results$profit[6], bad_results$profit[6] - bad_results$profit[7], bad_results$profit[7] - bad_results$profit[8], bad_results$profit[8] - bad_results$profit[9], bad_results$profit[9] - bad_results$profit[10], 0)
```

\newpage
```{r, tidy=TRUE}
good_results %>% 
  mutate(profit_margin_percent = round((price-costs)/price *100))

bad_results %>% 
  mutate(profit_margin_percent = round((price-costs)/price *100))
```

**Lowering the costs by $15 a unit would increase our profits by about $106,000 for good shelf location and $68,000 for bad shelf locations. Increasing the profit by $174,000. Also for good shelf location, the highest profit margin can be achieved at a cost of $40 which is a margin increase of 7% from our current $55 cost. For bad shelf location, the highest profit margin can be achieved at a cost of $40 which is a margin increase of 9% from our current $55 cost.**

```{r, echo=FALSE, figures-side, fig.show="hold", out.width="50%", tidy=TRUE}
good_results %>% 
  ggplot(mapping = aes(x = price, y = sales)) +
  geom_point() +
  labs(title = "Good Shelf Location Price and Sales Projections for Costs from $40 to $85")

bad_results %>% 
  ggplot(mapping = aes(x = price, y = sales)) +
  geom_point() +
  labs(title = "Bad Shelf Location Projections for Costs from $40 to $85")
```

**The optimal price range for costs between 40 to 85 for good shelf location is about $170 to $192 and bad shelf location of $126 to $149.** 
